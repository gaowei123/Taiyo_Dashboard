@{
    ViewBag.Title = "Home";
}

<script src="~/plugins/incubator-echarts-master/dist/echarts.min.js"></script>
<link href="~/Dashboard CSS JS/CSS/HomePage.css" rel="stylesheet" />


<style>
    .container-fluid{
        max-width:1500px;
    }
</style>

<div class="container-fluid">

    <div class="row topTitleRow">
        <div class="col-md-9">
            <img class="titleImg" src="~/Resources/Images/headericon.gif" />
            <span>Production Home Page</span>
        </div>
        <div class="col-md-3">
            <label id="lbTime" style="color:white; width:100%; text-align:right;"></label>
        </div>
    </div>


    <div class="row">
        <div class="col-sm-9" style="margin:0px;padding:0px;">
            <div id="divOutputTrendChart" class="area areaL areaChart"></div>
        </div>
        <div class="col-sm-3" style="margin:0px;padding:0px;">
            <div id="divDayPieChart" class="area areaR areaChart"></div>
        </div>
    </div>


    <div class="row">
        <div class="col-sm-3" style="margin:0px;padding:0px;">
            <div class="area areaL">
                <h4 class="statusTitle">Moulding</h4>

                <div class="row">
                    <div class="col-sm-12" style="display:flex; flex-direction:row;flex-wrap:wrap; justify-content:center;" id="divMouldingContain">
                        <div class="divController run" id="ctrl">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController idle">
                            <span class="statusFont">MC.2</span><br /><span class="statusFont">No Schedule</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.3</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.4</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.5</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController breakdown">
                            <span class="statusFont">MC.6</span><br /><span class="statusFont">Breakdown</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.7</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.8</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.9</span><br /><span class="statusFont">Run</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-sm-3" style="margin:0px;padding:0px;">
            <div class="area areaM">
                <h4 class="statusTitle">Laser</h4>

                <div class="row">
                    <div class="col-sm-12" style="display:flex; flex-direction:row;flex-wrap:wrap; justify-content:center;" id="divLaserContain">
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController idle">
                            <span class="statusFont">MC.2</span><br /><span class="statusFont">No Schedule</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.3</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.4</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.5</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController breakdown">
                            <span class="statusFont">MC.6</span><br /><span class="statusFont">Breakdown</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.7</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.8</span><br /><span class="statusFont">Run</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6" style="margin:0px;padding:0px;">
            <div class="area areaR">
                <h4 class="statusTitle">PQC</h4>

                <div class="row" style="margin:auto;">
                    <div class="col-sm-12" style="display:flex; flex-direction:row;flex-wrap:wrap; justify-content:center;" id="divPQCContain">
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                        <div class="divController run">
                            <span class="statusFont">MC.1</span><br /><span class="statusFont">Run</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    var apiGetTrendChartData = window.globalConfig.rootDirectory + '/Charts/GetHomeTrendData';
    var apiGetPieChartData = window.globalConfig.rootDirectory + '/Charts/GetTotalPieChartData';
    var apiGetMouldStatus = window.globalConfig.rootDirectory + '/Home/GetMouldStatus';
    var apiGetLaserStatus = window.globalConfig.rootDirectory + '/Home/GetLaserStatus';
    var apiGetPQCStatus = window.globalConfig.rootDirectory + '/Home/GetPQCStatus';

    //init chart
    var trendChart = echarts.init(document.getElementById('divOutputTrendChart'));
    var pieChart = echarts.init(document.getElementById('divDayPieChart'));



    $(document).ready(function () {

        generateTrendChart();

        generatePieChart();

        generateMouldStatus();

        generateLaserStatus();

        generatePQCStatus();

        generateLabelTime();


        //5min 刷新
        setInterval("generateTrendChart()", 300000);
        setInterval("generatePieChart()", 300000);

        //30s 刷新
        setInterval("generateMouldStatus()", 30000);
        setInterval("generateLaserStatus()", 30000);
        setInterval("generatePQCStatus()", 30000);

        //1min 刷新
        setInterval("generateLabelTime()", 60000);
    });






    function generateLabelTime() {
        var strDate = dateFormat('dd/MM/yyyy HH:mm', new Date());
        $('#lbTime').text(strDate);
    }

    function generateTrendChart() {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: apiGetTrendChartData,
            data: {},

            beforeSend: function () {
                trendChart.showLoading();
            },

            success: function (data) {
                if (data == null || data == undefined || data.length == 0) {
                    alert('There is no record found, Please try again!');
                    return false;
                }

                var series = [];
                for (var i = 0; i < data.SeriesData.length; i++) {
                    series.push({
                        name: data.SeriesData[i].Name,
                        type: data.SeriesData[i].Type,
                        data: data.SeriesData[i].Data,
                        label: {
                            show: true,
                        }
                    });
                }

                var option = {
                    title: {
                        text: 'Production Daily Output Trend'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'line'
                        }
                    },
                    legend: {
                        data: data.LegendData,
                        show: true
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            data: data.XAxisData
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    series: series
                };

                trendChart.clear();
                trendChart.setOption(option, true);
            },

            complete: function () {
                trendChart.hideLoading();
                trendChart.resize({ height: 300 });
            },

            error: function () {
                alert("Get chart data error !");
                trendChart.hideLoading();
            }
        });
    }

    function generatePieChart() {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: apiGetPieChartData,
            data: {},

            beforeSend: function () {
                pieChart.showLoading();
            },

            success: function (data) {
                if (data == null || data == undefined || data.length == 0) {
                    alert('There is no record found, Please try again!');
                    return false;
                }

                var totalOutput = 0;

                var seriesData = [];
                for (var i = 0; i < data.length; i++) {
                    seriesData.push({
                        name: data[i].Department,
                        value: data[i].Output
                    });

                    totalOutput += Number(data[i].Output);
                }

                var option = {
                    title: {
                        text: 'Today Output: ' + totalOutput,
                        //subtext: '纯属虚构',
                        left: 'left'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b} : {c} ({d}%)'
                    },
                    legend: {
                        type: 'scroll',
                        orient: 'vertical',
                        right: 0,
                        top: 20,
                        bottom: 20,
                        data: ['Moulding', 'Laser', 'Online', 'WIP', 'Packing']
                    },
                    series: [
                        {
                            name: 'Output',
                            type: 'pie',
                            radius: '60%',
                            center: ['43%', '55%'],
                            data: seriesData,
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 30,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };

                pieChart.clear();
                pieChart.setOption(option, true);
            },

            complete: function () {
                pieChart.hideLoading();
                pieChart.resize({ height: 300 });
            },

            error: function () {
                alert("Get pie chart data error !");
                pieChart.hideLoading();
            }
        });
    }

    function generateMouldStatus() {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: apiGetMouldStatus,
            data: {},

            beforeSend: function () {
                $("#divMouldingContain").empty();
                var strHtml = ' <div class="row text-center">\
                                    <i class="fa fa-spinner fa-spin fa-5x"></i>\
                                </div>';
                $("#divMouldingContain").append(strHtml);
            },

            success: function (data) {

                $("#divMouldingContain").empty();

                for (var i = 1; i < 10; i++) {

                    var strMc = 'Mc.' + i;
                    var strStatus = data[i].toUpperCase();

                    var classStatus = '';
                    if (strStatus == 'RUNNING' || strStatus == 'ADJUSTMENT' || strStatus == 'CHANGE MODEL' || strStatus == 'MOULD TESTING' || strStatus=='MATERIAL TESTING') {
                        classStatus = 'run';
                    } else if (strStatus == 'NO_SCHEDULE' || strStatus == "NO OPERATOR" || strStatus == "NO MATERIAL" || strStatus == "LOGIN LATE" || strStatus == 'BREAK TIME') {
                        classStatus = 'idle';
                    } else if (strStatus == 'DAMAGEMOULD') {
                        classStatus = 'breakdown';
                    } else {
                        classStatus = 'shutdown';
                    }


                    var strHtml = ' <div class="divController ' + classStatus + '">\
                                        <span class="statusFont">' + strMc + '</span><br /><span class="statusFont">' + strStatus + '</span>\
                                    </div>';
                    $("#divMouldingContain").append(strHtml);
                }


            },

            complete: function () {

            },

            error: function () {
                alert("Get mould status data error !");
            }
        });
    }

    function generateLaserStatus() {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: apiGetLaserStatus,
            data: {},

            beforeSend: function () {
                $("#divLaserContain").empty();
                var strHtml = ' <div class="row text-center">\
                                    <i class="fa fa-spinner fa-spin fa-5x"></i>\
                                </div>';
                $("#divLaserContain").append(strHtml);
            },

            success: function (data) {

                $("#divLaserContain").empty();

                for (var i = 1; i < 9; i++) {

                    var strMc = 'Mc.' + i;
                    var strStatus = data[i];

                    var classStatus = '';
                    if (strStatus == 'RUN' || strStatus == 'TESTING' || strStatus == 'SETUP' || strStatus == 'BUYOFF') {
                        classStatus = 'run';
                    } else if (strStatus == 'NO SCHEDULE' || strStatus == "MAINTAINENCE") {
                        classStatus = 'idle';
                    } else if (strStatus == 'BREAKDOWN') {
                        classStatus = 'breakdown';
                    } else {
                        classStatus = 'shutdown';
                    }


                    var strHtml = ' <div class="divController ' + classStatus + '">\
                                        <span class="statusFont">' + strMc + '</span><br /><span class="statusFont">' + strStatus + '</span>\
                                    </div>';
                    $("#divLaserContain").append(strHtml);
                }
            },

            complete: function () {

            },

            error: function () {
                alert("Get laser status data error !");
            }
        });
    }

    function generatePQCStatus() {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: apiGetPQCStatus,
            data: {},

            beforeSend: function () {
                $("#divPQCContain").empty();
                var strHtml = ' <div class="row text-center">\
                                    <i class="fa fa-spinner fa-spin fa-5x"></i>\
                                </div>';
                $("#divPQCContain").append(strHtml);
            },

            success: function (data) {

                $("#divPQCContain").empty();
                for (var i = 0; i < data.length; i++) {

                    var strMc = 'Sta.' + (i + 1);
                    var strStatus = data[i].Status;

                    var classStatus = '';
                    if (strStatus == 'CHECKING' || strStatus == 'PACKING') {
                        classStatus = 'run';
                    } else if (strStatus == 'NO SCHEDULE') {
                        classStatus = 'idle';
                    } else {
                        classStatus = 'shutdown';
                    }


                    var strHtml = ' <div class="divController ' + classStatus + '">\
                                        <span class="statusFont">' + strMc + '</span><br /><span class="statusFont">' + strStatus + '</span>\
                                    </div>';
                    $("#divPQCContain").append(strHtml);
                }
            },

            complete: function () {

            },

            error: function () {
                alert("Get pqc status data error !");
            }
        });
    }




    $(window).resize(function () {
        trendChart.resize({ height: 300 });
        pieChart.resize({ height: 300 });
    });

</script>